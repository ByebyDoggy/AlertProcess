from typing import Literal
from database.models import ContractAddressDB
from processor.core import AlertProcessor, AlertProcessorConfig,ProcessedResult
from processor.core import AlertInput
from arkm import AsyncArkmClient, SyncArkmClient

ChainIDToARKMNetwork = {
    1: "ethereum",
    56: "bsc",
    137: "polygon",
}

# 检测规则，检查利用者是否是可信实体，若为可信实体直接通过，跳过后续检测(对于arkm实体，除了hacker其余实体均可信)

class ExploiterARKMLabelCheckAlertProcessorConfig(AlertProcessorConfig):
    processor_name: str = "ExploiterARKMLabelCheckAlertProcessor"
    blacklist_entity_types: list[str] = ['hacker']
    arkm_cookie: str

class ExploiterARKMLabelCheckAlertProcessor(AlertProcessor):
    def __init__(self,config: ExploiterARKMLabelCheckAlertProcessorConfig):
        super().__init__(config)
        self.arkm_client = AsyncArkmClient(
            cookie=config.arkm_cookie
        )
        self.arkm_sync_client = SyncArkmClient(
            cookie=config.arkm_cookie
        )
        self.config: ExploiterARKMLabelCheckAlertProcessorConfig = config

    async def _process_alert(self, alert:AlertInput):
        # 优先尝试从本地数据库查找
        arkm_entity_type = None
        contract_entity =self.db.query(
            ContractAddressDB
        ).where(
            ContractAddressDB.contract_address == alert.exploiter_address
        ).first()
        if contract_entity:
            arkm_entity_type = contract_entity.entity_type
        else:
            response = self.arkm_sync_client.get(
                path=f"/intelligence/address_enriched/{alert.exploiter_address}/all?includeTags=true&includeEntityPredictions=true&includeClusters=true"
            )
            for arkm_chain, chain_data in response.items():
                if arkm_chain == ChainIDToARKMNetwork[alert.chain_id]:
                    arkm_entity = chain_data.get("arkhamEntity")
                    if arkm_entity:
                        arkm_entity_type = arkm_entity.get("type")
                    # arkm_label = chain_data.get("arkhamLabel")

        if arkm_entity_type:
            if arkm_entity_type not in self.config.blacklist_entity_types:
                # 若实体类型不在黑名单中，直接通过
                return ProcessedResult(
                    need_more_check=False,
                    process_details=[{
                        "entity_type": arkm_entity_type,
                        "reason": f"entity type {arkm_entity_type} not in blacklist"
                    }]
                )
            else:
                # 若实体类型在黑名单中，返回-1
                return ProcessedResult(
                    need_more_check=True,
                    process_details=[{
                        "entity_type": arkm_entity_type,
                        "reason": f"exploiter is not a entity or"
                              f" entity type {arkm_entity_type} in blacklist"
                }],
                score=1000
            )

        else:
            # 利用者非实体，正常推进到下一个流程
            return ProcessedResult(
                need_more_check=True,
                process_details=[{
                    "entity_type": arkm_entity_type,
                    "reason": f"exploiter is not a entity,hacker or a normal user"
                }],
                score=0
            )
