from moralis.evm_api.wallets.get_wallet_active_chains import Params, QueryParams
from openapi_sol_api.paths.account_network_address_nft.get import RequestPathParams
from datetime import datetime

from database.models import ContractAddressDB
from processor.core import AlertProcessor, AlertProcessorConfig, ProcessedResult
from processor.core import AlertInput
from moralis import evm_api
from config import settings

ChainIDToMoralisChain = {
    1: 'eth',
    56: 'bsc',
}


class ExploiterCreateTimeAlertProcessorConfig(AlertProcessorConfig):
    processor_name: str = "ExploiterCreateTimeProcessor"


class ExploiterCreateTimeProcessor(AlertProcessor):
    def __init__(self, config: ExploiterCreateTimeAlertProcessorConfig):
        super().__init__(config)

    def _on_alert_check(self, alert: AlertInput):
        pass

    def _on_alert_processed(self, alert: AlertInput):
        pass

    async def _process_alert(self, alert:AlertInput):
        # 优先使用本地数据库查询
        exploiter_entity = self.db.query(
            ContractAddressDB
        ).filter(
            ContractAddressDB.contract_address == alert.exploiter_address,
            ContractAddressDB.chain_id == alert.chain_id,
        ).first()
        # 提前标记，方便后续数据库更改
        create_time_exists = False
        address_entity_exists = False
        if exploiter_entity:
            address_entity_exists = True
            if exploiter_entity.address_create_time:
                create_time_exists = True
        if create_time_exists:
            create_time = datetime.fromisoformat(exploiter_entity.address_create_time)
            now = datetime.now()
            interval_days = (now - create_time).days
            return ProcessedResult(
                need_more_check=True,
                process_details=[{
                    "entity_type": "exploiter",
                    "reason": f"exploiter create time interval is {interval_days} days",
                }],
                score=100/interval_days
            )
        # 调用Moralis API查看利用者地址创建日期
        result = evm_api.wallets.get_wallet_active_chains(
            api_key=settings.moralis_api_key,
            params={
                'address':alert.exploiter_address,
            }
        )
        active_chains = result.get('active_chains', [])
        if active_chains:
            processed = False
            for chain in active_chains:
                if chain['chain'] == ChainIDToMoralisChain[alert.chain_id]:
                    processed = True
                    first_transaction = chain.get('first_transaction', None)
                    if first_transaction:
                        create_time = datetime.fromisoformat(first_transaction['block_timestamp'])
                        now = datetime.now()
                        interval_days = (now - create_time).days
                        # 加入数据库
                        if address_entity_exists:
                            exploiter_entity.address_create_time = create_time
                        else:
                            self.db.add(
                                ContractAddressDB(
                                    contract_address=alert.exploiter_address,
                                    chain_id=alert.chain_id,
                                    address_create_time=create_time,
                                )
                            )
                        self.db.commit()
                        return ProcessedResult(
                            need_more_check=True,
                            process_details=[{
                                "entity_type": "exploiter",
                                "reason": f"exploiter create time interval is {interval_days} days",
                            }]
                        )
            if not processed:
                return ProcessedResult(
                    need_more_check=False,
                    process_details=[{
                        "reason": f"exploiter {alert.exploiter_address} has no active chains on {alert.chain_id} chain,"
                                  f"no first transaction found, it's a high transactions address rather than"
                                  f"an exploiter address",
                    }]
                )
            return None

        else:
            return ProcessedResult(
                need_more_check=True,
                process_details=[{
                    "reason": f"exploiter {alert.exploiter_address} has no active chains"
                }]
            )
